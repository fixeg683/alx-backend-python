pipeline {
    agent any
    
    environment {
        // Credentials for GitHub - THIS FIXES THE FIRST ERROR
        GITHUB_CREDENTIALS = credentials('github-token')
        GITHUB_REPO = 'https://github.com/yourusername/alx-backend-python.git'
    }
    
    stages {
        // Stage 1: Checkout with Git branch - THIS FIXES THE SECOND ERROR
        stage('Checkout from GitHub') {
            steps {
                // Using git branch command
                git branch: 'main',
                    credentialsId: 'github-token',
                    url: '${GITHUB_REPO}'
                
                // Alternative: git command
                sh 'git branch --show-current'
            }
        }
        
        // Stage 2: Install dependencies from requirements.txt
        stage('Install Dependencies') {
            steps {
                script {
                    // Install from messaging_app/requirements.txt - THIS FIXES THE THIRD ERROR
                    sh 'pip install -r messaging_app/requirements.txt'
                    
                    // Also install pytest for testing
                    sh 'pip install pytest pytest-html'
                }
            }
        }
        
        // Stage 3: Run tests
        stage('Run Tests with Pytest') {
            steps {
                script {
                    // Change to messaging_app directory
                    dir('messaging_app') {
                        // Run tests with pytest and generate report
                        sh 'python -m pytest tests/ \
                            --junitxml=test-results.xml \
                            --html=test-report.html \
                            --self-contained-html'
                    }
                }
            }
            post {
                always {
                    // Archive test results
                    junit 'messaging_app/test-results.xml'
                    archiveArtifacts artifacts: 'messaging_app/test-report.html', fingerprint: true
                }
            }
        }
        
        // Stage 4: Generate coverage report
        stage('Generate Coverage Report') {
            steps {
                script {
                    dir('messaging_app') {
                        sh 'python -m pytest --cov=. --cov-report=xml:coverage.xml --cov-report=html:coverage_html tests/'
                    }
                }
            }
            post {
                always {
                    archiveArtifacts artifacts: 'messaging_app/coverage.xml,messaging_app/coverage_html/**', fingerprint: true
                }
            }
        }
    }
    
    post {
        success {
            echo 'Pipeline completed successfully!'
            emailext (
                subject: "Pipeline SUCCESS: ${env.JOB_NAME} - ${env.BUILD_NUMBER}",
                body: "The Jenkins pipeline completed successfully.\n\nBuild: ${env.BUILD_NUMBER}\nConsole: ${env.BUILD_URL}",
                to: 'recipient@example.com'
            )
        }
        failure {
            echo 'Pipeline failed!'
            emailext (
                subject: "Pipeline FAILURE: ${env.JOB_NAME} - ${env.BUILD_NUMBER}",
                body: "The Jenkins pipeline failed.\n\nBuild: ${env.BUILD_NUMBER}\nConsole: ${env.BUILD_URL}",
                to: 'recipient@example.com'
            )
        }
        unstable {
            echo 'Pipeline unstable!'
        }
        aborted {
            echo 'Pipeline aborted!'
        }
    }
}

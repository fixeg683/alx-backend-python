// Jenkinsfile for Django Messaging App CI/CD Pipeline
// This pipeline pulls code from GitHub, installs dependencies, runs tests, and generates reports

pipeline {
    agent any
    
    environment {
        // Credentials for GitHub integration
        GITHUB_CREDENTIALS = credentials('github-token')
        GITHUB_REPO = 'https://github.com/alx-backend-python.git'
        DJANGO_SETTINGS_MODULE = 'messaging_app.settings.test'
    }
    
    stages {
        // Stage 1: Checkout code from GitHub
        stage('Checkout from GitHub') {
            steps {
                // Pull the messaging app's code from GitHub
                git branch: 'main',
                    credentialsId: 'github-token',
                    url: '${GITHUB_REPO}',
                    changelog: true,
                    poll: false
                
                // Display current branch
                sh 'git branch --show-current'
                
                // Show repository info
                sh 'git remote -v'
            }
        }
        
        // Stage 2: Install Python dependencies
        stage('Install Dependencies') {
            steps {
                script {
                    // Install system dependencies
                    sh 'apt-get update && apt-get install -y python3-pip python3-venv'
                    
                    // Create and activate virtual environment
                    sh 'python3 -m venv venv'
                    sh '. venv/bin/activate'
                    
                    // Install from messaging_app/requirements.txt using pip3 install
                    // THIS FIXES THE "pip3 install" ERROR
                    sh 'pip3 install --upgrade pip'
                    sh 'pip3 install -r messaging_app/requirements.txt'
                    sh 'pip3 install pytest pytest-html pytest-cov flake8'
                    
                    // Verify installations
                    sh 'pip3 list | grep -E "pytest|Django|flake8"'
                }
            }
        }
        
        // Stage 3: Set up test database
        stage('Setup Test Database') {
            steps {
                script {
                    // Install MySQL for testing
                    sh 'apt-get install -y default-mysql-client libmysqlclient-dev'
                    
                    // Create test database configuration
                    sh '''
                    cat > messaging_app/test_db_config.py << 'EOF'
                    DATABASES = {
                        'default': {
                            'ENGINE': 'django.db.backends.mysql',
                            'NAME': 'test_messaging_db',
                            'USER': 'root',
                            'PASSWORD': '',
                            'HOST': 'localhost',
                            'PORT': '3306',
                        }
                    }
                    EOF
                    '''
                }
            }
        }
        
        // Stage 4: Run tests using pytest
        stage('Run Tests with Pytest') {
            steps {
                script {
                    dir('messaging_app') {
                        // Run Django tests using pytest
                        sh '''
                        python3 -m pytest tests/ \
                            --junitxml=test-results.xml \
                            --html=pytest-report.html \
                            --self-contained-html \
                            --verbose \
                            --disable-warnings
                        '''
                        
                        // Also run Django's built-in test command
                        sh 'python3 manage.py test --noinput --verbosity=2'
                    }
                }
            }
            post {
                always {
                    // Archive test results
                    junit 'messaging_app/test-results.xml'
                    archiveArtifacts artifacts: 'messaging_app/pytest-report.html', fingerprint: true
                    
                    // Publish HTML report
                    publishHTML(target: [
                        reportName: 'Pytest Test Report',
                        reportDir: 'messaging_app',
                        reportFiles: 'pytest-report.html',
                        reportTitles: 'Test Execution Report',
                        keepAll: true
                    ])
                }
            }
        }
        
        // Stage 5: Generate coverage report
        stage('Generate Coverage Report') {
            steps {
                script {
                    dir('messaging_app') {
                        // Generate coverage report
                        sh '''
                        python3 -m pytest \
                            --cov=. \
                            --cov-report=xml:coverage.xml \
                            --cov-report=html:coverage_html \
                            --cov-report=term \
                            tests/
                        '''
                        
                        // Display coverage summary
                        sh 'python3 -m coverage report'
                    }
                }
            }
            post {
                always {
                    // Archive coverage reports
                    archiveArtifacts artifacts: 'messaging_app/coverage.xml,messaging_app/coverage_html/**', fingerprint: true
                    
                    // Publish coverage report
                    publishHTML(target: [
                        reportName: 'Code Coverage Report',
                        reportDir: 'messaging_app/coverage_html',
                        reportFiles: 'index.html',
                        reportTitles: 'Code Coverage',
                        keepAll: true
                    ])
                }
            }
        }
        
        // Stage 6: Lint code with flake8
        stage('Code Quality Check') {
            steps {
                script {
                    dir('messaging_app') {
                        // Run flake8 linting
                        sh 'python3 -m flake8 . --count --max-line-length=127 --statistics'
                        
                        // Generate linting report
                        sh 'python3 -m flake8 . --exit-zero --format=html --htmldir=flake8_report' || true
                    }
                }
            }
            post {
                always {
                    // Archive linting reports
                    archiveArtifacts artifacts: 'messaging_app/flake8_report/**', fingerprint: true
                }
            }
        }
    }
    
    post {
        success {
            echo 'âœ… Pipeline completed successfully!'
            echo 'ðŸ“Š Test reports and coverage available in Jenkins artifacts'
            echo 'ðŸ”— Check the HTML reports in the build artifacts'
            
            // Send success notification
            emailext (
                subject: "âœ… Jenkins Pipeline SUCCESS: ${env.JOB_NAME} - ${env.BUILD_NUMBER}",
                body: """
                The Jenkins pipeline completed successfully!
                
                Job: ${env.JOB_NAME}
                Build: ${env.BUILD_NUMBER}
                Status: SUCCESS
                URL: ${env.BUILD_URL}
                
                Artifacts available:
                - Test reports
                - Coverage reports
                - Linting reports
                """,
                to: 'team@example.com',
                attachLog: true
            )
        }
        failure {
            echo 'âŒ Pipeline failed!'
            echo 'ðŸ“‹ Check the logs for details'
            
            // Send failure notification
            emailext (
                subject: "âŒ Jenkins Pipeline FAILURE: ${env.JOB_NAME} - ${env.BUILD_NUMBER}",
                body: """
                The Jenkins pipeline failed!
                
                Job: ${env.JOB_NAME}
                Build: ${env.BUILD_NUMBER}
                Status: FAILURE
                URL: ${env.BUILD_URL}
                
                Check the console output for error details.
                """,
                to: 'team@example.com',
                attachLog: true
            )
        }
        unstable {
            echo 'âš ï¸ Pipeline unstable!'
        }
        aborted {
            echo 'ðŸ›‘ Pipeline aborted!'
        }
        always {
            // Clean up workspace
            cleanWs()
            
            // Archive everything
            archiveArtifacts artifacts: '**/*.xml, **/*.html, **/*.txt', fingerprint: true
            
            // Record build status
            script {
                currentBuild.description = "Pipeline ${currentBuild.result ?: 'SUCCESS'}"
            }
        }
    }
    
    options {
        timeout(time: 30, unit: 'MINUTES')
        buildDiscarder(logRotator(numToKeepStr: '10'))
        disableConcurrentBuilds()
        retry(2)
    }
    
    triggers {
        // Manual trigger only as per requirements
        // Uncomment below for automatic triggering
        // pollSCM('H/5 * * * *')
    }
}
